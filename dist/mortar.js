/**
 * MortarJS Copyright (c) 2014 Miguel Castillo.
 * Licensed under MIT
 */

/**
 * almond 0.2.6 Copyright (c) 2011-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

/**
 * scpromise Copyright (c) 2014 Miguel Castillo.
 * Licensed under MIT
 *
 * Simple Compliant Promise
 * https://github.com/MiguelCastillo/scpromise
 */

(function(e,t){typeof define=="function"&&define.amd?define(t):e.mortar=t()})(this,function(){var e,t,n;return function(r){function d(e,t){return h.call(e,t)}function v(e,t){var n,r,i,s,o,u,a,f,c,h,p=t&&t.split("/"),d=l.map,v=d&&d["*"]||{};if(e&&e.charAt(0)===".")if(t){p=p.slice(0,p.length-1),e=p.concat(e.split("/"));for(f=0;f<e.length;f+=1){h=e[f];if(h===".")e.splice(f,1),f-=1;else if(h===".."){if(f===1&&(e[2]===".."||e[0]===".."))break;f>0&&(e.splice(f-1,2),f-=2)}}e=e.join("/")}else e.indexOf("./")===0&&(e=e.substring(2));if((p||v)&&d){n=e.split("/");for(f=n.length;f>0;f-=1){r=n.slice(0,f).join("/");if(p)for(c=p.length;c>0;c-=1){i=d[p.slice(0,c).join("/")];if(i){i=i[r];if(i){s=i,o=f;break}}}if(s)break;!u&&v&&v[r]&&(u=v[r],a=f)}!s&&u&&(s=u,o=a),s&&(n.splice(0,o,s),e=n.join("/"))}return e}function m(e,t){return function(){return s.apply(r,p.call(arguments,0).concat([e,t]))}}function g(e){return function(t){return v(t,e)}}function y(e){return function(t){a[e]=t}}function b(e){if(d(f,e)){var t=f[e];delete f[e],c[e]=!0,i.apply(r,t)}if(!d(a,e)&&!d(c,e))throw new Error("No "+e);return a[e]}function w(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function E(e){return function(){return l&&l.config&&l.config[e]||{}}}var i,s,o,u,a={},f={},l={},c={},h=Object.prototype.hasOwnProperty,p=[].slice;o=function(e,t){var n,r=w(e),i=r[0];return e=r[1],i&&(i=v(i,t),n=b(i)),i?n&&n.normalize?e=n.normalize(e,g(t)):e=v(e,t):(e=v(e,t),r=w(e),i=r[0],e=r[1],i&&(n=b(i))),{f:i?i+"!"+e:e,n:e,pr:i,p:n}},u={require:function(e){return m(e)},exports:function(e){var t=a[e];return typeof t!="undefined"?t:a[e]={}},module:function(e){return{id:e,uri:"",exports:a[e],config:E(e)}}},i=function(e,t,n,i){var s,l,h,p,v,g=[],w;i=i||e;if(typeof n=="function"){t=!t.length&&n.length?["require","exports","module"]:t;for(v=0;v<t.length;v+=1){p=o(t[v],i),l=p.f;if(l==="require")g[v]=u.require(e);else if(l==="exports")g[v]=u.exports(e),w=!0;else if(l==="module")s=g[v]=u.module(e);else if(d(a,l)||d(f,l)||d(c,l))g[v]=b(l);else{if(!p.p)throw new Error(e+" missing "+l);p.p.load(p.n,m(i,!0),y(l),{}),g[v]=a[l]}}h=n.apply(a[e],g);if(e)if(s&&s.exports!==r&&s.exports!==a[e])a[e]=s.exports;else if(h!==r||!w)a[e]=h}else e&&(a[e]=n)},e=t=s=function(e,t,n,a,f){return typeof e=="string"?u[e]?u[e](t):b(o(e,t).f):(e.splice||(l=e,t.splice?(e=t,t=n,n=null):e=r),t=t||function(){},typeof n=="function"&&(n=a,a=f),a?i(r,e,t,n):setTimeout(function(){i(r,e,t,n)},4),s)},s.config=function(e){return l=e,l.deps&&s(l.deps,l.callback),s},e._defined=a,n=function(e,t,n){t.splice||(n=t,t=[]),!d(a,e)&&!d(f,e)&&(f[e]=[e,t,n])},n.amd={jQuery:!0}}(),n("lib/js/almond",function(){}),n("mortar/extender",[],function(){function e(){this.extend.apply(this,arguments)}return e.prototype.extend=function(){var t=Array.prototype.slice.call(arguments),n;while(t.length)n=t.shift(),n.constructor===Function?(e.extension.prototype=n.prototype,_.extend(this,new e.extension)):_.extend(this,n);return this},e.extension=function(){},e.mixin=function(){var t=new e,n=Array.prototype.slice.call(arguments),r=n.shift();return r.constructor===Function?(t.extend.apply(r.prototype,n),r.prototype.extend=t.extend):t.extend.apply(r,n),r.extend=e.extend,r},e.extend=function(){function n(){this.constructor.apply(this,arguments)}var t;return this===e?t=Array.prototype.slice.call(arguments).shift():t=this,t&&t.constructor===Function?e.extension.prototype=t.prototype:e.extension.prototype=t,n.prototype=new e.extension,n.__super__=t.prototype,e.mixin.apply(t,[n].concat.apply(n,arguments)),n},e}),n("mortar/events",["mortar/extender"],function(e){function n(){}function r(){}var t={};return t.object=function(e,t){if(typeof arguments[0]!="object")return;var r={events:{}};for(var i in e)r.events[i]=n.normalize.apply(this,[i,e[i],e[i].context||t]);return r},t.string=function(e,t,r){if(typeof arguments[0]!="string")return;e=e.split(",");var i={events:{}},s=e.length,o=0;for(;o<s;o++)i.events[e[o]]=n.normalize.apply(this,[e[o],t,r]);return i},n.normalize=function(e,t,n){var r=e.split(" "),i=r.shift(),s=r.join(" ")||null,o=i.split(":").length!==1;return typeof t=="string"&&(t=this[t]),n&&typeof t=="function"&&(t=$.proxy(t,n)),{type:i,selector:s,cb:t,custom:o}},n.bind=function(){var e=$(this),t=r.configure.apply(this,arguments),n=t.events||{},i;for(var s in n){i=n[s];if(!i.cb)continue;e.on(i.type+"."+r.prefix,i.selector,i.cb)}return this},n.unbind=function(){var e=$(this);return arguments[0]?e.off.apply(e,arguments):e.off("."+r.prefix),this},e.mixin(r,{events:{}}),r.prefix="mortar",r.factory=n,r.converters=t,r.configure=function(){var e=r.converters[typeof arguments[0]];if(e)return e.apply(this,arguments)},r.prototype.on=function(){return r.factory.bind.apply(this,arguments)},r.prototype.off=function(){return r.factory.unbind.apply(this,arguments)},r.prototype.trigger=function(){var e=$(this);return e.trigger.apply(e,arguments),this},r.prototype.triggerHandler=function(){var e=$(this);return e.triggerHandler.apply(e,arguments),this},r}),n("mortar/hash.route",[],function(){function s(e){return typeof e=="string"&&(e={pattern:e}),e.pattern in i==0&&(i[e.pattern]=new s.route(e)),i[e.pattern]}function o(){t=""+window.location.hash;if(t===e)return;$(s).triggerHandler("change",[t,e]);for(var n in i)i[n].exec(t);e=t}function u(){r&&clearTimeout(r),r=setTimeout(o,s.refreshRate)}function a(e){var t=a.rules,n=(""+e).replace(t.wholeValue.regex,function(e){return e.substr(0,e.indexOf(":"))+t.wholeValue.rule}).replace(t.optionalValue.regex,function(e){return e.substr(0,e.indexOf(":"))+t.optionalValue.rule}).replace(t.nameValue.regex,function(e){return e.substr(0,e.indexOf(":"))+t.nameValue.rule}).replace(t.wildCard.regex,t.wildCard.rule),r=new RegExp("^(?:#*/*)"+n+"(?:/*)$");return function(e){return e.match(r)}}function f(e){function o(e){if(!r)return!1;var i=n(e);return i?(t.lastUrl=i.shift(),t.lastMatch=i.join("-")):t.lastMatch=undefined,i}function u(e){var n=t.lastMatch,r=o(e);r&&n!==t.lastMatch&&(t.triggerHandler("change",r),$(s).triggerHandler("route:change",[t,r]))}function f(){$(i[t.pattern]).off(),delete i[t.pattern]}function l(e){if(arguments.length===0)return r===!0;r=e}function h(){var e=arguments[1],n=arguments[2];typeof e=="function"&&(n=e,e="");var r=t.match(""+window.location.hash);return r&&(r.unshift(jQuery.Event("init")),setTimeout(function(){n.apply(t,r),$(s).triggerHandler("route:init",t)},1)),c.apply(t,arguments),t}var t=$({}),n=a(e.pattern),r=!0,c=t.on;return t.match=o,t.exec=u,t.unregister=f,t.enable=l,t.pattern=e.pattern,t.on=h,t}var e="",t="",n=!1,r=!1,i={};return s.refreshRate=10,s.enable=function(){if(n)return;n=!0,"onhashchange"in window?($(window).on("hashchange",u),r=setTimeout(o,s.refreshRate)):r=setInterval(o,100)},s.disable=function(e){if(n===!1)return;n=!1,"onhashchange"in window?($(window).off("hashchange",u),clearTimeout(r)):clearInterval(r)},s.navigate=function(e){window.location.hash=e},a.rules={wildCard:{regex:/\/\*\*/g,rule:"(?:.*)"},wholeValue:{regex:/\*\*\w*:\w+/g,rule:"(.*)"},optionalValue:{regex:/\*\w*:\w+/g,rule:"([^/]*)"},nameValue:{regex:/\w*:\w+/g,rule:"([^/]+)"}},s.patternMatch=a,s.route=f,s.enable(),s}),n("mortar/model",["mortar/extender","mortar/events"],function(e,t){function n(e,t,r){r=r||{};var i,s={context:this,type:e,url:_.result({url:r.url||this.url},"url")};switch(e.toLocaleLowerCase()){case"post":case"put":i=_.result({data:t||this.deserialize},"data"),s.data=i&&JSON.stringify(i),s.contentType="application/json; charset=utf-8";break;default:i=_.result({data:t||this.deserialize},"data"),s.data=i&&JSON.stringify(i)}_.extend(s,this.ajax,r.ajax);if(s.url)return $.when(n.transaction(s));throw"Must provide a url in order to make ajax calls.  Optionally, you can override or provide a custom data source that does not require a url."}function r(){}function i(e,t){if(this instanceof i==0)return new i(e,t);var n=i.configure.apply(this,arguments);this.on(this.events).on(n.events),_.extend(this,n.options),this.serialize(this.defaultdata)}return n.transaction=$.ajax,r.prototype.create=function(e,t){return $.when(this.datasource("post",e,t)).then(function(e){return e})},r.prototype.read=function(e,t){return $.when(this.datasource("get",e,t)).then(function(e){return this.serialize(e),e})},r.prototype.update=function(e,t){return $.when(this.datasource("put",e,t)).then(function(e){return e})},r.prototype.remove=function(e,t){return $.when(this.datasource("delete",e,t)).then(function(e){return e})},i.datasource=n,e.mixin(i,{ajax:{dataType:"json"},bind:$.noop,unbind:$.noop},t,r),i.configure=function(e,t){var n;typeof e=="string"||typeof e=="function"?(n=e,e=null):typeof t=="string"||typeof t=="function"?(n=t,t=null):!t&&e&&(e.data||e.url||e.events||e.datasource)&&(t=_.extend({},e),e=e.data),t=t||{},t.defaultdata=e,t.datasource=t.datasource||i.datasource,n&&(t.url=n);var r=t.events||{};return delete t.events,{data:e,events:r,options:t}},i.prototype.serialize=function(e,t){this.data?this.data instanceof Array?(this.data.splice(0,this.data.length),this.data.push.apply(this,e)):_.extend(this.data,e):this.data=e},i.prototype.deserialize=function(){return this.data},i.prototype.get=function(e){return this.data[e]},i.prototype.set=function(e,t){this.data[e]=t},i}),n("mortar/fetch",[],function(){function t(t){if(!t)throw"Invalid settings";typeof t=="string"&&(t={url:t});if(t.url in e==0||t.refresh===!0){var n=_.extend({url:t.url,cache:!1},t.ajax);e[t.url]=$.ajax(n),t.cache===!1&&e[t.url].always(function(){delete e[t.url]})}return e[t.url]}var e={};return t.get=function(t){return e[t]},t.remove=function(t){t in e&&delete e[t]},t.clear=function(){for(var t in e)delete e[t]},t}),n("mortar/style",["mortar/fetch"],function(e){function t(e){var t=e.lastIndexOf(".");if(t!==-1)return e.substr(t+1)}function n(t,n){return e({url:t,ajax:{dataType:n}})}function r(e){if(this instanceof r==0)return new r(e);var n=$.Deferred();e=e||{};if(typeof e.url=="string"){e.type=e.type||t(e.url);var i=r.handler[e.type];i&&i.load(e,n)}else n.reject("No suitable option");return n}return r.handler={css:{dataType:"text",load:function(e,t){n(e.url,"text").done(function(e){$("<style type='text/css'>"+e+"</style>").appendTo("head"),t.resolve(e)})}},$css:{load:function(e,t){n(e.url,"json").done(function(n){e.element instanceof jQuery&&e.element.css(n),t.resolve(n)})}},less:{load:function(e,t){n(e.url,"text").done(function(e){t.resolve(e)})}}},r}),n("mortar/tmpl",["mortar/fetch"],function(e){function t(e,n){if(this instanceof t==0)return new t(e,n);e=e||{},n=n||e.selector||t.selector;var r=$.Deferred(),i="["+n+"]";return typeof e.url=="string"?t.loader(e).done(r.resolve).fail(r.reject):typeof e.html=="string"||e.html instanceof jQuery==1?r.resolve(e.html):r.resolve(e),r.then(function(e){var r=$(e),s=r.filter(i).add(r.children(i)).add(r.find(i)).map(function(){var e=$(this);return t({url:e.attr(n)}).done(function(t){e.append($(t))})});return s.length?$.when.apply(t,s).then(function(){return r}):r})}return t.selector="mjs-tmpl",t.loader=e,t}),n("mortar/promise",["mortar/extender"],function(e){function i(s){function f(e,t){var r=new i;return setTimeout(function(){try{s.done(function(){S(r,n.resolve,e,arguments)}),s.fail(function(){S(r,n.reject,t,arguments)})}catch(i){r.reject(i)}},1),r}function l(e){return g()?s:(b(r.resolved,e),s)}function c(e){return m()?s:(b(r.rejected,e),s)}function h(){if(!y())throw"Promise is already resolved";return E(t.resolved,Array.prototype.slice.call(arguments)),s}function p(){if(!y())throw"Promise is already resolved";return E(t.rejected,Array.prototype.slice.call(arguments)),s}function d(e){return b(r.always,e),s}function v(){return o}function m(){return o===t.resolved}function g(){return o===t.rejected}function y(){return o===t.pending}function b(e,t){if(typeof t!="function")throw"Callback must be a valid function";y()?u[e].push(t):(r.resolved===e&&m()||r.rejected===e&&g())&&t.apply(a[0],a)}function w(e){var t,n;for(t=0,n=e.length;t<n;t++)e[t].apply(a[0],a);e.splice(0,e.length)}function E(e,n){o=e,a=n,w(u[e===t.resolved?r.resolved:r.rejected]),w(u[r.always])}function S(e,t,n,r){var i=n&&n.apply(r[0],r)||r;n&&i&&typeof i.then=="function"?i.then.call(r[0],function(){e.resolve.apply(arguments,arguments)},function(){e.reject.apply(arguments,arguments)}):(i=i&&[i],e[t].apply(i,i))}s=s||{};var o=t.pending,u={always:[],resolved:[],rejected:[]},a;return e.mixin(s,{always:d,done:l,fail:c,resolve:h,reject:p,then:f,state:v,isResolved:m,isRejected:g,isPending:y})}var t={pending:0,resolved:1,rejected:2},n={resolve:"resolve",reject:"reject"},r={always:"always",resolved:"resolved",rejected:"rejected"};return i.when=function(){function u(){o&&o--,o||t.resolve.apply(e,e)}function a(t){return function(n){e[t]=n,u()}}function f(){t.reject.apply(arguments,arguments)}function l(){try{for(n=0,r=e.length,o=e.length;n<r;n++)s=e[n],s&&typeof s.then=="function"?s.then(a(n),f):(e[n]=s,u())}catch(t){f(t)}}var e=Array.prototype.slice.call(arguments).slice(0),t=new i,n,r,s,o;return e.length?(setTimeout(l,1),t):t.resolve(null)},i}),n("mortar/view",["mortar/extender","mortar/events","mortar/tmpl","mortar/model","mortar/style","mortar/promise"],function(e,t,n,r,i,s){function o(){}function u(e){var t=this,n=new s,r=u.configure.apply(t,arguments);_.extend(t,r.options),t.$el.addClass(t.className),t.on(t.events).on(r.events),t.on.call(t.$el,t.events,t),t.on.call(t.$el,r.events,t),t.ready=n.done,s.when(t._init(e)).then(function(){return u.resources.load.call(t,t.resources)}).then(function(){return s.when(t._create(e))}).then(function(){t.trigger("_create").trigger("view:ready",[t,e]),n.resolve(t)})}return o.handlers={tmpl:n,model:r,style:i},o.get=function(e,t){if(!t||!o.handlers[t])return;if(e.url&&e.url.lastIndexOf(".")===-1)switch(t){case"style":e.url+=".css";break;case"tmpl":e.url+=".html";break;case"model":e.url+=".js"}return o.handlers[t](e)},o.load=function(e){var t=this,n,r,i,u,a={};for(var f in e)n=e[f],/\w+!.*/.test(f)&&(r=/(\w+)!(.*)/.exec(f),u=r.pop(),f=r.pop(),i={},i[u]=n||t.path,n=i),a[f]=o.get(n,f);return s.when(a.tmpl,a.model,a.style).then(function(e,n){e&&t.$el.empty().append($(e));if(n){t.model=n;if(_.result(n,"url"))return n.read().then(function(){return n.bind(t.$el),a});n.bind(t.$el)}return a})},e.mixin(u,{tagName:"div",className:"view",_init:$.noop,_create:$.noop,_destroy:$.noop},t),u.prototype.destroy=function(){this.trigger("_destroy").trigger("view:destroy"),this.off().off.call(this.$el),this.$el.remove(),this.model&&this.model.unbind()},u.prototype.transition=function(e,t){var n=this._lastView;if(n==e)return;this.trigger("view:transition",[e,n]),n&&(n.trigger("view:leave",[this]),this.managed!==!1&&typeof n.destroy=="function"&&n.destroy()),this._lastView=e,t?$(t,this.$el).append(e.$el||e):this.$el.append(e.$el||e),e.trigger("view:enter",[this])},u.configure=function(e){e instanceof jQuery?e={$el:e}:e=_.extend({},e);var t=_.extend({},e.events);delete e.events;var n=e.tagName||this.tagName;e.$el=e.$el||$("<"+n+">");var r=e.path||this.path;if(r){var i=r.split("/");e.name=i.pop(),e.namespace=i.join(".")}return e.className=e.className||e.name||this.className,{events:t,options:e}},u.resources=o,u}),n("mortar/core",["mortar/extender","mortar/events","mortar/hash.route","mortar/model","mortar/fetch","mortar/style","mortar/tmpl","mortar/view","mortar/promise"],function(e,t,n,r,i,s,o,u,a){return{extender:e,events:t,hash:n,model:r,fetch:i,style:s,tmpl:o,view:u,promise:a}}),t("mortar/core")});